/**
 *  @license justcore
 *  Copyright Â© Valentin Lozev 2016 - Present
 *  Licensed under the MIT license: http://www.opensource.org/licenses/mit-license.php
 *  Source code: http://github.com/valentin-lozev/justcore
 */
!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(exports):"function"==typeof define&&define.amd?define(["exports"],factory):factory((global=global||self).justcore={})}(this,function(exports){"use strict";var errorCodes={m1:function(){return"use(): extensions must be installed before init"},m2:function(){return"use(): extensions must be passed as an array"},m3:function(){return"use(): extension must be an object"},m4:function(){return"use(): extension name must be a non empty string"},m5:function(id){return'use(): "'+id+'" install must be a function'},m6:function(id){return'use(): "'+id+'" has already been used'},m7:function(){return"init(): core has already been initialized"},m8:function(){return"addModule(): id must be a non empty string"},m9:function(id){return'addModule(): "'+id+'" has already been added'},m10:function(id){return'addModule(): "'+id+'" factory must be a function'},m11:function(){return"startModule(): core must be initialized first"},m12:function(id){return'startModule(): "'+id+'" not found'},m13:function(id){return'startModule(): "'+id+"\"'s sandbox property must be a Sandbox instance"},m14:function(id){return'startModule(): "'+id+'" init hook must be defined'},m15:function(id){return'startModule(): "'+id+'" destroy hook must be defined'},m16:function(){return"createHook(): type must be a non empty string"},m17:function(id){return'createHook(): "'+id+'" method must be a function'},m18:function(){return"addPlugin(): hook type must be a non empty string"},m19:function(id){return'addPlugin(): "'+id+'" plugin must be a function'},m20:function(){return"onMessage(): message type must be a non empty string"},m21:function(id){return'onMessage(): "'+id+'" handler should be a function'},m22:function(){return"publishAsync(): message must be an object"},m23:function(id){return'"'+id+'" moduleDidReceiveMessage hook must be defined in order to subscribe'},m24:function(){return"addService(): key must be a non empty string"},m25:function(key){return'addService(): "'+key+'" has already been added'},m26:function(key){return'addService(): "'+key+'" factory must be a function that returns service instance'},m27:function(key){return"getService(): "+key+" service not found"}};function throwError(code,formatId){throw new Error((0,errorCodes[code])(formatId))}var guard=new(function(){function ArgumentGuard(){}return ArgumentGuard.prototype.array=function(arg,code,formatId){return Array.isArray(arg)||throwError(code,formatId),this},ArgumentGuard.prototype.object=function(arg,code,formatId){return"object"==typeof arg&&null!==arg||throwError(code,formatId),this},ArgumentGuard.prototype.function=function(arg,code,formatId){return"function"!=typeof arg&&throwError(code,formatId),this},ArgumentGuard.prototype.nonEmptyString=function(arg,code,formatId){return"string"==typeof arg&&arg.length||throwError(code,formatId),this},ArgumentGuard.prototype.true=function(arg,code,formatId){return arg||throwError(code,formatId),this},ArgumentGuard.prototype.false=function(arg,code,formatId){return arg&&throwError(code,formatId),this},ArgumentGuard}());var hasOwnProperty=Object.prototype.hasOwnProperty,lastUID=0;function moduleAutosubscribe(){return{name:"module-autosubscribe",install:function(){return{onModuleInit:function(next){next(),function(){var core=this.sandbox._extensionsOnlyCore,messages="function"==typeof this.moduleWillSubscribe?core.createHook("onModuleSubscribe",this.moduleWillSubscribe,this)():null;if(Array.isArray(messages)&&0<=messages.length){guard.function(this.moduleDidReceiveMessage,"m23",this.sandbox.moduleId);var moduleDidReceiveMessage=core.createHook("onModuleReceiveMessage",this.moduleDidReceiveMessage,this);this.sandbox._unsubscribers=messages.reduce(function(map,message){return map[message]=core.onMessage(message,moduleDidReceiveMessage),map},Object.create(null))}}.call(this)},onModuleDestroy:function(next){(function(){var unsubscribers=this.sandbox._unsubscribers;unsubscribers&&Object.keys(unsubscribers).forEach(function(message){unsubscribers[message](),unsubscribers[message]=null,delete unsubscribers[message]})}).call(this),next()}}}}}"function"!=typeof Array.prototype.reduceRight&&(Array.prototype.reduceRight=function(callback){if(null==this)throw new TypeError("Array.prototype.reduce called on null or undefined");if("function"!=typeof callback)throw new TypeError(callback+" is not a function");var value,t=Object(this),k=(t.length>>>0)-1;if(2<=arguments.length)value=arguments[1];else{for(;0<=k&&!(k in t);)k--;if(k<0)throw new TypeError("Reduce of empty array with no initial value");value=t[k--]}for(;0<=k;k--)k in t&&(value=callback(value,t[k],k,t));return value});var HooksSystem=function(){function HooksSystem(){this._plugins=Object.create(null)}return HooksSystem.prototype.createHook=function(type,method,context){guard.nonEmptyString(type,"m16").function(method,"m17",type);function result(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];var plugins=hooksContext._plugins[type];return plugins?plugins.reduceRight(function(pipeline,plugin){return function(){return plugin.apply(context,function(){for(var s=0,i=0,il=arguments.length;i<il;i++)s+=arguments[i].length;var r=Array(s),k=0;for(i=0;i<il;i++)for(var a=arguments[i],j=0,jl=a.length;j<jl;j++,k++)r[k]=a[j];return r}([pipeline],args))}},function(){return method.apply(context,args)})():method.apply(context,args)}var hooksContext=this;return result._withPipeline=!0,result._hookType=type,result},HooksSystem.prototype.addPlugin=function(hookType,plugin){guard.nonEmptyString(hookType,"m18").function(plugin,"m19",hookType),(this._plugins[hookType]||(this._plugins[hookType]=[])).push(plugin)},HooksSystem}(),MessageBus=function(){function MessageBus(){this._subscribers=Object.create(null)}return MessageBus.prototype.onMessage=function(type,handler){return guard.nonEmptyString(type,"m20").function(handler,"m21",type),this._addSubscriber(type,handler)},MessageBus.prototype.publishAsync=function(message){var _this=this;if(guard.true("object"==typeof message,"m22"),message.type in this._subscribers){var subscriptions=this._subscribers[message.type];Object.keys(subscriptions).forEach(function(id){_this._publishSingle(message,subscriptions[id])})}},MessageBus.prototype._publishSingle=function(message,handler){setTimeout(function(){try{handler(message)}catch(err){console.error('publishAsync(): Receive "'+message.type+'" message failed.'),console.error(err)}},0)},MessageBus.prototype._addSubscriber=function(type,handler){var _this=this;type in this._subscribers||(this._subscribers[type]=Object.create(null));var subscriptionId=++lastUID;return this._subscribers[type][subscriptionId]=handler,function(){_this._subscribers[type][subscriptionId]=null,delete _this._subscribers[type][subscriptionId]}},MessageBus}(),Sandbox=function(){function Sandbox(core,moduleId,instanceId){this._extensionsOnlyCore=core,this._moduleId=moduleId,this._instanceId=instanceId}return Object.defineProperty(Sandbox.prototype,"moduleId",{get:function(){return this._moduleId},enumerable:!0,configurable:!0}),Object.defineProperty(Sandbox.prototype,"instanceId",{get:function(){return this._instanceId},enumerable:!0,configurable:!0}),Sandbox.prototype.startModule=function(id,options){this._extensionsOnlyCore.startModule(id,options)},Sandbox.prototype.stopModule=function(id,instanceId){this._extensionsOnlyCore.stopModule(id,instanceId)},Sandbox.prototype.publishAsync=function(message){this._extensionsOnlyCore.publishAsync(message)},Sandbox.prototype.getService=function(key){return this._extensionsOnlyCore.serviceLocator.getService(key)},Sandbox}(),ServiceLocator=function(){function ServiceLocator(){this.container=Object.create(null),this.instantiationsStack=[]}return ServiceLocator.prototype.addService=function(key,factory){guard.nonEmptyString(key,"m24").false(hasOwnProperty.call(this.container,key),"m25",key).function(factory,"m26",key),this.container[key]={factory:factory,instance:null}},ServiceLocator.prototype.getService=function(key){var serviceData=this.container[key];if(guard.true(!!serviceData,"m27",key),serviceData.instance)return serviceData.instance;if(this.isServiceBeingInstantiated(key))throw new Error("getService(): service circular dependency "+this.instantiationsStack.join(" -> ")+" -> "+key);this.instantiationsStack.push(key);try{serviceData.instance=serviceData.factory()}finally{this.instantiationsStack.pop()}return serviceData.instance},ServiceLocator.prototype.isServiceBeingInstantiated=function(key){return-1<this.instantiationsStack.indexOf(key)},ServiceLocator}(),Core=function(){function Core(hooksSystem,messageBus,serviceLocator){void 0===hooksSystem&&(hooksSystem=new HooksSystem),void 0===messageBus&&(messageBus=new MessageBus),void 0===serviceLocator&&(serviceLocator=new ServiceLocator),this.Sandbox=Sandbox,this._isInitialized=!1,this._onInit=null,this._hooksSystem=null,this._messageBus=null,this._extensions=Object.create(null),this._modules=Object.create(null),this._hooksSystem=hooksSystem,this._messageBus=messageBus,this.serviceLocator=serviceLocator,this._onDomReady=this._onDomReady.bind(this),this.use([moduleAutosubscribe()])}return Object.defineProperty(Core.prototype,"version",{get:function(){return"2.0.0"},enumerable:!0,configurable:!0}),Object.defineProperty(Core.prototype,"extensions",{get:function(){return Object.keys(this._extensions)},enumerable:!0,configurable:!0}),Object.defineProperty(Core.prototype,"modules",{get:function(){return Object.keys(this._modules)},enumerable:!0,configurable:!0}),Object.defineProperty(Core.prototype,"runningModules",{get:function(){var _this=this;return this.modules.reduce(function(result,id){return result[id]=Object.keys(_this._modules[id].instances),result},Object.create(null))},enumerable:!0,configurable:!0}),Core.prototype.use=function(extensions){var _this=this;guard.false(this._isInitialized,"m1").array(extensions,"m2"),extensions.forEach(function(x){guard.object(x,"m3").nonEmptyString(x.name,"m4").function(x.install,"m5",x.name).false(x.name in _this._extensions,"m6",x.name),_this._extensions[x.name]=x})},Core.prototype.createHook=function(type,method,context){return this._hooksSystem.createHook(type,method,context)},Core.prototype.init=function(onInit){var state;guard.false(this._isInitialized,"m7"),this._onInit=this.createHook("onCoreInit",onInit||function(){},this),this._createHooks(),this._installExtensions(),"complete"===(state=document.readyState)||"interactive"===state||"loaded"===state?setTimeout(this._onDomReady,0):document.addEventListener("DOMContentLoaded",this._onDomReady),this._isInitialized=!0},Core.prototype.addModule=function(id,factory){guard.nonEmptyString(id,"m8").false(id in this._modules,"m9").function(factory,"m10",id),this._modules[id]={factory:factory,instances:Object.create(null)}},Core.prototype.startModule=function(id,options){void 0===options&&(options={}),guard.true(this._isInitialized,"m11").true(id in this._modules,"m12",id);var moduleData=this._modules[id],instanceId=options.instanceId||id,instance=moduleData.instances[instanceId];if(instance)"function"==typeof instance.moduleDidReceiveProps&&this.createHook("onModuleReceiveProps",instance.moduleDidReceiveProps,instance)(options.props);else if(instance=this._createModule(id,instanceId,moduleData.factory))try{this.createHook("onModuleInit",instance.init,instance)(options.props),moduleData.instances[instanceId]=instance}catch(err){console.error('startModule(): "'+id+'" init failed'),console.error(err)}},Core.prototype.stopModule=function(id,instanceId){var moduleData=this._modules[id];if(moduleData)if((instanceId=instanceId||id)in moduleData.instances)try{var instance=moduleData.instances[instanceId];this.createHook("onModuleDestroy",instance.destroy,instance)(),delete moduleData.instances[instanceId]}catch(err){console.error('stopModule(): "'+id+'" destroy failed'),console.error(err)}else console.warn('stopModule(): "'+id+'"\'s "'+instanceId+'" instance is not running');else console.warn('stopModule(): "'+id+'" not found')},Core.prototype.onMessage=function(type,handler){return this._messageBus.onMessage(type,handler)},Core.prototype.publishAsync=function(message){this._messageBus.publishAsync(message)},Core.prototype._createHooks=function(){this.addModule=this.createHook("onModuleAdd",this.addModule,this),this.startModule=this.createHook("onModuleStart",this.startModule,this),this.stopModule=this.createHook("onModuleStop",this.stopModule,this),this.onMessage=this.createHook("onMessageSubscribe",this.onMessage,this),this.publishAsync=this.createHook("onMessagePublish",this.publishAsync,this)},Core.prototype._installExtensions=function(){var _this=this;Object.keys(this._extensions).forEach(function(name){return _this._install(_this._extensions[name])})},Core.prototype._install=function(extension){var _this=this,plugins=extension.install(this)||{};Object.keys(plugins).forEach(function(hookType){return _this._hooksSystem.addPlugin(hookType,plugins[hookType])})},Core.prototype._onDomReady=function(){document.removeEventListener("DOMContentLoaded",this._onDomReady),this._onInit()},Core.prototype._createModule=function(id,instanceId,factory){var result=null;try{result=factory(new this.Sandbox(this,id,instanceId)),guard.true(result.sandbox instanceof this.Sandbox,"m13",id).function(result.init,"m14",id).function(result.destroy,"m15",id)}catch(err){result=null,console.error(err)}return result},Core}();exports.Core=Core,Object.defineProperty(exports,"__esModule",{value:!0})});
